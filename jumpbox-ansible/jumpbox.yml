---
  # Launch instances, runs some tasks
  # and then terminate them
  
  - name: Boot the jumpbox
    hosts: local
    gather_facts: False
    vars:
      vpc_id : "{{ jumpbox_vpc_id }}"
      subnet_id : "{{ jumpbox_subnet_id }}"
      keypair: "{{ sshkeyname }}"
      instance_type: t2.micro
      security_group_id: "{{ sg_id }}"
      security_group_name: "{{ sg_name }}"
    tasks:
      - name: Create Keypair
        amazon.aws.ec2_key:
          name: "{{ keypair }}"
          key_material: "{{ sshkeyvalue }}"
          region: "{{ region }}"

      - name: SSH security group rule descriptions
        amazon.aws.ec2_group:
          name: "{{ security_group_name }}"
          vpc_id: "{{ vpc_id }}"
          region: "{{ region }}"
          state: 'present'
          description: "Allow SSH inbound from Workstation"
          rules:
            - proto: tcp
              ports:
              - 22
              cidr_ip: 2.3.4.5/32
              rule_desc: "SSH from Workstation"

      - name: Launch instance
        amazon.aws.ec2:
          key_name: "{{ keypair }}"
          group: "{{ security_group_name }}"
          # instance_type: "{{ instance_type }}"
          # image: "{{ image }}"
          state: 'running'
          region: "{{ region }}"
          # vpc_subnet_id: "{{ subnet_id }}" 
        #   assign_public_ip: yes
        #   instance_tags:
        #     Name: JumpBoxSSH
        #     AnsibleGroup: jumpboxes
        # register: ec2

  - name: Stop Jumpbox
    hosts: local
    tasks:
      - name: Terminate instances that were previously launched
        amazon.aws.ec2:
          state: 'stopped'
          instance_ids: '{{ ec2.instance_ids }}'
          region: "{{ region }}"
